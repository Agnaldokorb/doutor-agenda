<!doctype html>
<html>
  <head>
    <title>Debug Auth - Deploy Vercel</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .form {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .result {
        margin: 10px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }
      .success {
        background: #e8f5e8;
        color: #2e7b32;
        border: 1px solid #c8e6c9;
      }
      .loading {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffcc02;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #1976d2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px 5px 5px 0;
      }
      button:hover {
        background: #1565c0;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .debug-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Debug Auth - Deploy Vercel</h1>

      <div class="debug-info">
        <h3>‚ÑπÔ∏è Informa√ß√µes do Ambiente</h3>
        <p><strong>URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
        <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
      </div>

      <div class="form">
        <h2>ü©∫ 1. Testar Health Check</h2>
        <button onclick="testHealthCheck()">Verificar API</button>
        <div id="healthResult" class="result"></div>
      </div>

      <div class="form">
        <h2>üóÑÔ∏è 2. Testar Conex√£o com Banco</h2>
        <button onclick="testDatabase()">Testar Banco</button>
        <div id="dbResult" class="result"></div>
      </div>

      <div class="form">
        <h2>üë§ 3. Criar Usu√°rio (com detalhes do erro)</h2>
        <input
          type="text"
          id="regName"
          placeholder="Nome"
          value="Admin Teste"
        />
        <input
          type="email"
          id="regEmail"
          placeholder="Email"
          value="admin@teste.com"
        />
        <input
          type="password"
          id="regPassword"
          placeholder="Senha"
          value="123456789"
        />
        <input
          type="text"
          id="regClinic"
          placeholder="Nome da Cl√≠nica"
          value="Cl√≠nica Teste"
        />
        <label>
          <input type="checkbox" id="regPrivacy" checked />
          Aceito a Pol√≠tica de Privacidade
        </label>
        <br /><br />
        <button onclick="createUser()">Criar Usu√°rio</button>
        <div id="regResult" class="result"></div>
      </div>

      <div class="form">
        <h2>üîê 4. Fazer Login</h2>
        <input
          type="email"
          id="loginEmail"
          placeholder="Email"
          value="admin@teste.com"
        />
        <input
          type="password"
          id="loginPassword"
          placeholder="Senha"
          value="123456789"
        />
        <button onclick="loginUser()">Login</button>
        <div id="loginResult" class="result"></div>
      </div>

      <div class="form">
        <h2>üìß 5. Testar Email</h2>
        <input
          type="email"
          id="testEmail"
          placeholder="Seu email para teste"
          value=""
        />
        <button onclick="testEmail()">Testar Email</button>
        <div id="emailResult" class="result"></div>
      </div>
    </div>

    <script>
      // Preencher informa√ß√µes do ambiente
      document.getElementById("currentUrl").textContent = window.location.href;
      document.getElementById("userAgent").textContent = navigator.userAgent;
      document.getElementById("timestamp").textContent =
        new Date().toISOString();

      async function testHealthCheck() {
        const result = document.getElementById("healthResult");
        result.className = "result loading";
        result.textContent = "Testando API...";

        try {
          const response = await fetch("/api/health", {
            method: "GET",
          });

          const data = await response.text();

          if (response.ok) {
            result.className = "result success";
            result.textContent = `‚úÖ API OK (${response.status})\n${data}`;
          } else {
            result.className = "result error";
            result.textContent = `‚ùå API Error (${response.status})\n${data}`;
          }
        } catch (error) {
          result.className = "result error";
          result.textContent = `‚ùå Network Error: ${error.message}`;
        }
      }

      async function testDatabase() {
        const result = document.getElementById("dbResult");
        result.className = "result loading";
        result.textContent = "Testando conex√£o com banco...";

        try {
          const response = await fetch("/api/debug-db", {
            method: "GET",
          });

          const data = await response.text();

          if (response.ok) {
            result.className = "result success";
            result.textContent = `‚úÖ Banco OK (${response.status})\n${data}`;
          } else {
            result.className = "result error";
            result.textContent = `‚ùå Banco Error (${response.status})\n${data}`;
          }
        } catch (error) {
          result.className = "result error";
          result.textContent = `‚ùå Database Error: ${error.message}`;
        }
      }

      async function createUser() {
        const result = document.getElementById("regResult");
        result.className = "result loading";
        result.textContent = "Criando usu√°rio...";

        const userData = {
          name: document.getElementById("regName").value,
          email: document.getElementById("regEmail").value,
          password: document.getElementById("regPassword").value,
          clinicName: document.getElementById("regClinic").value,
          privacyPolicyAccepted: document.getElementById("regPrivacy").checked,
        };

        console.log("üìä Enviando dados:", userData);

        try {
          const response = await fetch("/api/debug-user", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          const responseText = await response.text();
          console.log("üì® Resposta:", responseText);

          let data;
          try {
            data = JSON.parse(responseText);
          } catch {
            data = { raw: responseText };
          }

          if (response.ok) {
            result.className = "result success";
            result.textContent = `‚úÖ Usu√°rio criado com sucesso!\n\nStatus: ${response.status}\nResposta: ${JSON.stringify(data, null, 2)}`;
          } else {
            result.className = "result error";
            result.textContent = `‚ùå Erro ${response.status}\n\nResposta completa:\n${JSON.stringify(data, null, 2)}\n\nRaw response:\n${responseText}`;
          }
        } catch (error) {
          result.className = "result error";
          result.textContent = `‚ùå Network/Parse Error:\n${error.message}\n\nStack:\n${error.stack}`;
          console.error("‚ùå Erro completo:", error);
        }
      }

      async function loginUser() {
        const result = document.getElementById("loginResult");
        result.className = "result loading";
        result.textContent = "Fazendo login...";

        try {
          const response = await fetch("/api/auth/sign-in/email", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: document.getElementById("loginEmail").value,
              password: document.getElementById("loginPassword").value,
            }),
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch {
            data = { raw: responseText };
          }

          if (response.ok) {
            result.className = "result success";
            result.textContent = `‚úÖ Login realizado com sucesso!\n\n${JSON.stringify(data, null, 2)}`;
          } else {
            result.className = "result error";
            result.textContent = `‚ùå Erro ${response.status}\n\n${JSON.stringify(data, null, 2)}\n\nRaw: ${responseText}`;
          }
        } catch (error) {
          result.className = "result error";
          result.textContent = `‚ùå Login Error: ${error.message}`;
        }
      }

      async function testEmail() {
        const result = document.getElementById("emailResult");
        const email = document.getElementById("testEmail").value;

        if (!email) {
          result.className = "result error";
          result.textContent = "‚ùå Por favor, digite um email para teste";
          return;
        }

        result.className = "result loading";
        result.textContent = "Testando envio de email...";

        try {
          const response = await fetch("/api/email/test", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              type: "connection",
              email: email,
            }),
          });

          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch {
            data = { raw: responseText };
          }

          if (response.ok) {
            result.className = "result success";
            result.textContent = `‚úÖ Email testado com sucesso!\n\n${JSON.stringify(data, null, 2)}`;
          } else {
            result.className = "result error";
            result.textContent = `‚ùå Erro ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
          }
        } catch (error) {
          result.className = "result error";
          result.textContent = `‚ùå Email Error: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
